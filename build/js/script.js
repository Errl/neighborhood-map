"use strict";function addScript(e,o){var t=document.createElement("script");o&&(t.onload=o),t.type="text/javascript",t.src=e,document.body.appendChild(t)}function loadMapsAPI(){addScript("https://maps.googleapis.com/maps/api/js?libraries=places&key=AIzaSyDLRxZMTqapXSFfZG3_NGCTJc3R_NvBAro&sensor=false&callback=mapsApiReady")}function mapsApiReady(){addScript("js/lib/infobox.js",initialize)}var locations=[{name:"9/11 Tribute Center",myLat:40.709784,myLng:-74.012432,photo:"img/911tribute.jpg",address:"120 Liberty St, New York, NY 10006 (212) 393-9160"},{name:"NY Stock Exchange",myLat:40.707096,myLng:-74.010675,photo:"img/stockexchange.jpg",address:"11 Wall St, New York, NY 10005 (212) 656-3000"},{name:"The National September 11 Memorial",myLat:40.71316,myLng:-74.013365,photo:"img/911 memorial.jpg",address:"10007, 80 Greenwich St, New York, NY 10006"},{name:"South Street Seaport",myLat:40.705856,myLng:-74.0019,photo:"img/seaport.jpg",address:"New York, NY 10038 (212) 732-8257"},{name:"NY City Hall",myLat:40.71316,myLng:-74.006389,photo:"img/cityhall.jpg",address:"City Hall Park New York, NY (212) 639-9675"},{name:"US Post Office",myLat:40.720497,myLng:-74.004107,photo:"img/postoffice.jpg",address:"350 Canal St New York, NY 10013"},{name:"Tribeca Grand Hotel",myLat:40.719418,myLng:-74.004788,photo:"img/tribeca.jpg",address:"2 Avenue of the Americas, New York, NY 10013, United States tribecagrand.com (212) 519-6600"}],Place=function(e){this.name=ko.observable(e.name),this.myLat=e.myLat,this.myLng=e.myLng,this.marker=e.marker,this.position=e.position,this.address=ko.observable(e.address),this.photo=e.photo,this.content=e.content,this.icon=e.icon,this.type=e.types},map,i;window.onload=loadMapsAPI;var initialize=function(){var e=new google.maps.LatLng(40.715369,-73.998259),o={zoom:14,center:e,draggablecursur:null,mapTypeControl:!0,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.HORIZONTAL_BAR,position:google.maps.ControlPosition.TOP_CENTER},panControl:!1,panControlOptions:{position:google.maps.ControlPosition.TOP_CENTER},zoomControl:!0,zoomControlOptions:{style:google.maps.ZoomControlStyle.SMALL,position:google.maps.ControlPosition.LEFT_TOP},scaleControl:!0,streetViewControl:!0,streetViewControlOptions:{position:google.maps.ControlPosition.LEFT_TOP}};map=new google.maps.Map(document.getElementById("map-canvas"),o);var t=function(){function o(e){e.marker.setAnimation(null)}function t(e,o){var t=new google.maps.places.PlacesService(map);if(o==google.maps.places.PlacesServiceStatus.OK)for(var n=0;n<e.length;n++){var i=e[n],s={placeId:i.place_id};t.getDetails(s,a)}}function a(e,o){o==google.maps.places.PlacesServiceStatus.OK&&(e.address=e.formatted_address,e.phone=e.formatted_phone_number,e.position=e.geometry.location,e.reviews&&(e.review=e.reviews[0].text),e.photos&&(e.photo=e.photos[0].getUrl({maxWidth:200,maxHeight:200})),e.content='<div id="infobox"><img src="'+e.photo+'"><p>'+e.name+"</p><p>"+e.phone+"</p><p>"+e.address+"</p><p> Avg. Rating:"+e.rating+"</p><p>"+e.review+"</p></div>",e.icon="http://google.com/mapfiles/ms/micons/red-pushpin.png",e.marker=n(e),g.placeList.push(new Place(e)),s(e))}function n(e){var o=new google.maps.Marker({map:map,position:e.position,animation:google.maps.Animation.DROP,icon:e.icon});return o.setVisible(!1),u.push(o),o}function s(e){google.maps.event.addListener(e.marker,"click",function(){c();var o=new InfoBox({content:e.content,disableAutoPan:!1,maxWidth:150,pixelOffset:new google.maps.Size(-140,0),zIndex:null,boxStyle:{background:"url('http://google-maps-utility-library-v3.googlecode.com/svn/trunk/infobox/examples/tipbox.gif') no-repeat",opacity:.75,width:"280px"},closeBoxMargin:"12px 4px 2px 2px",closeBoxURL:"http://www.google.com/intl/en_us/mapfiles/close.gif",infoBoxClearance:new google.maps.Size(1,1)});h.push(o),o.open(map,this),setTimeout(function(){o.close()},1e4)})}function r(o){var a=new google.maps.places.PlacesService(map);google.maps.event.addListener(o,"places_changed",function(){var o=map.getBounds(),n=$("#search-input").val(),i={location:e,radius:2e3,query:n};d(g.placeList),g.placeList.removeAll(),g.couponList.removeAll(),l(n),a.textSearch(i,t),map.fitBounds(o),map.setZoom(14)}),google.maps.event.addListener(map,"bounds_changed",function(){var e=map.getBounds();o.setBounds(e)})}function l(e){var o="http://api.sqoot.com/v2/deals?api_key=sq7r8u&query="+e+"&location=10013&radius=1",t=setTimeout(function(){$("#dealTitle").text("failed to get wikipedia resources")},8e3);$.ajax({url:o,dataType:"jsonp",beforeSend:function(){$("#image").show()},complete:function(){$("#image").hide()},success:function(e){for(var o=e.deals,a=0;a<o.length;a++){var n=o[a];p(n)}clearTimeout(t)}})}function p(e){var o=e.deal.merchant.latitude,t=e.deal.merchant.longitude;e.position=new google.maps.LatLng(o,t),e.icon="http://maps.google.com/mapfiles/kml/pal2/icon61.png",e.photo=e.deal.image_url,e.addressFormatted=e.deal.merchant.address+"<br/>"+e.deal.merchant.locality+", "+e.deal.merchant.region,e.address=e.deal.merchant.address+"  "+e.deal.merchant.locality+", "+e.deal.merchant.region,e.dealTitle=e.deal.short_title,e.name=e.deal.merchant.name,e.marker=n(e),e.url=e.deal.url,e.content='<div id="infobox"><img class="markerImg" src="'+e.photo+'"><p>'+e.name+"</p><p>"+e.addressFormatted+"</p><p> Coupon:<br/>"+e.dealTitle+'</p><li><a class="dealUrl" href="'+e.url+'">'+e.url+"</a></li></div>",g.couponList.push(new Place(e)),s(e)}function m(){for(i=0;i<locations.length;i++){var e=locations[i];e.position=new google.maps.LatLng(e.myLat,e.myLng),e.icon="http://google.com/mapfiles/ms/micons/flag.png",e.marker=n(e),e.marker.setVisible(!0),e.content='<div id="infobox"><img class="photo" src="'+e.photo+'"><p>'+e.name+"</p><p>"+e.address+"</p></div>",g.impPlaceList.push(new Place(e)),s(e)}}function c(){for(var e=0;e<h.length;e++)h[e].close()}function d(e){for(var o=0;o<e().length;o++){var t=e()[o].marker;t.setVisible(!1)}}var g=this,u=[],h=[];g.placeList=ko.observableArray([]),g.impPlaceList=ko.observableArray([]),g.searchTerm=ko.observable("restaurant"),g.couponList=ko.observableArray([]),g.filter=ko.observable("");var f=document.getElementById("responsive");map.controls[google.maps.ControlPosition.LEFT_BOTTOM].push(f);var v=document.getElementById("couponList");map.controls[google.maps.ControlPosition.LEFT_BOTTOM].push(v);var y=document.getElementById("impList");map.controls[google.maps.ControlPosition.RIGHT_TOP].push(y);var L=document.getElementById("list");map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(L);var k=document.getElementById("search-input");map.controls[google.maps.ControlPosition.TOP_LEFT].push(k);var b=document.getElementById("search");map.controls[google.maps.ControlPosition.TOP_LEFT].push(b);var w=new google.maps.places.SearchBox(k),T=new google.maps.places.PlacesService(map),C={location:e,radius:2500,query:"food"};l("restaurant"),T.textSearch(C,t),r(w),m(),g.filteredItems=ko.computed(function(){var e=this.filter().toLowerCase();return e?ko.utils.arrayFilter(g.placeList(),function(o){var t=-1!==o.name().toLowerCase().indexOf(e)||-1!==o.address().toLowerCase().indexOf(e);return t}):g.placeList()},g),g.filteredDeals=ko.computed({read:function(){var e=this.filter().toLowerCase();return e?ko.utils.arrayFilter(g.couponList(),function(o){var t=-1!==o.name().toLowerCase().indexOf(e)||-1!==o.address().toLowerCase().indexOf(e);return t}):g.couponList()}},g),g.togglePlacesMarkers=ko.dependentObservable(function(){var e=ko.utils.compareArrays(g.placeList(),g.filteredItems()),o=[],t=[];for(ko.utils.arrayForEach(e,function(e){"deleted"===e.status?o.push(e.value):"retained"===e.status&&t.push(e.value)}),i=0;i<o.length;i++){var a=o[i];a.marker.setVisible(!1)}for(i=0;i<t.length;i++){var n=t[i];n.marker.setVisible(!0)}return o},g),g.toggleDealsMarkers=ko.dependentObservable(function(){var e=ko.utils.compareArrays(g.couponList(),g.filteredDeals()),o=[],t=[];for(ko.utils.arrayForEach(e,function(e){"deleted"===e.status?o.push(e.value):"retained"===e.status&&t.push(e.value)}),i=0;i<o.length;i++){var a=o[i];a.marker.setVisible(!1)}for(i=0;i<t.length;i++){var n=t[i];n.marker.setVisible(!0)}return o},g),g.clickMarker=function(e){c(),map.panTo(e.position),e.marker.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){o(e)},4e3)}};ko.applyBindings(new t)};